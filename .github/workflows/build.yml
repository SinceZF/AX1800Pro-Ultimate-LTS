name: ImmortalWrt-360V6-Stable

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
        python3 python3-distutils rsync unzip zlib1g-dev file wget \
        libelf-dev

    - name: Clone ImmortalWrt 23.05 (Locked)
      run: |
        git clone https://github.com/immortalwrt/immortalwrt.git openwrt
        cd openwrt
        git checkout a9d3c1b7f4e6b2c8d0e5f7a1c3b9e8d6f2a4c1e0

    - name: Update Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load Config
      run: |
        cat > openwrt/.config <<EOF
        CONFIG_TARGET_ipq60xx=y
        CONFIG_TARGET_ipq60xx_generic=y
        CONFIG_TARGET_ipq60xx_generic_DEVICE_360v6=y
        CONFIG_LINUX_5_15=y

        # 关闭 NSS 保证稳定
        # CONFIG_PACKAGE_kmod-qca-nss-drv is not set
        # CONFIG_PACKAGE_kmod-qca-nss-ecm is not set

        # SQM + CAKE
        CONFIG_PACKAGE_sqm-scripts=y
        CONFIG_PACKAGE_luci-app-sqm=y
        CONFIG_PACKAGE_kmod-sched-cake=y

        # 广告拦截
        CONFIG_PACKAGE_adguardhome=y
        CONFIG_PACKAGE_luci-app-adguardhome=y

        # DNS
        CONFIG_PACKAGE_smartdns=y
        CONFIG_PACKAGE_luci-app-smartdns=y

        # IPv6
        CONFIG_PACKAGE_ipv6helper=y
        CONFIG_PACKAGE_odhcp6c=y
        EOF

        cd openwrt
        make defconfig

    - name: Download Packages
      run: |
        cd openwrt
        make download -j8

    - name: Compile
      run: |
        cd openwrt
        make -j$(nproc)

    - name: Save Firmware
      run: |
        mkdir firmware
        find openwrt/bin/targets/ -type f -name "*360v6*.bin" -exec cp {} firmware/ \;

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: 360V6-Stable-Firmware
        path: firmware/