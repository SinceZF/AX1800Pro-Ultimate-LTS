name: 360V6-LTS-Pro

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 6'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex g++ gawk gcc-multilib \
        g++-multilib gettext git libncurses-dev libssl-dev python3-distutils \
        rsync unzip zlib1g-dev file wget curl jq

    - name: Clone ImmortalWrt
      run: |
        git clone https://github.com/immortalwrt/immortalwrt -b openwrt-23.05 openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Detect Device
      run: |
        cd openwrt
        DEVICE=$(grep -r "360v6" target/linux/ipq60xx/image/*.mk | head -n1 | sed 's/.*DEVICE_//;s/ .*//')
        if [ -z "$DEVICE" ]; then
          echo "Device not found"
          exit 1
        fi
        echo "DEVICE_NAME=$DEVICE" >> $GITHUB_ENV

    - name: Load Config
      run: |
        cp config/360v6.config openwrt/.config
        cd openwrt
        make defconfig

    - name: Add Custom Files
      run: |
        cp -r files openwrt/

    - name: Compile
      run: |
        cd openwrt
        make download -j8
        make -j$(nproc)

    - name: Locate Firmware
      run: |
        FILES=$(find openwrt/bin/targets/ -name "*factory.bin" -o -name "*sysupgrade.bin")
        if [ -z "$FILES" ]; then
          echo "No firmware found"
          exit 1
        fi
        echo "FIRMWARE_FILES<<EOF" >> $GITHUB_ENV
        echo "$FILES" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Generate Tag
      id: tag
      run: echo "TAG=360V6-LTS-$(date +%Y%m%d)-${{ github.run_number }}" >> $GITHUB_OUTPUT

    - name: Release
      if: success()
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag.outputs.TAG }}
        name: 360V6 LTS Firmware
        files: ${{ env.FIRMWARE_FILES }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Cleanup Old Releases
      if: success()
      run: |
        REPO=${{ github.repository }}
        TOKEN=${{ secrets.GITHUB_TOKEN }}

        RELEASES=$(curl -s -H "Authorization: token $TOKEN" \
        https://api.github.com/repos/$REPO/releases | jq -r '.[].id')

        COUNT=0
        for ID in $RELEASES; do
          COUNT=$((COUNT+1))
          if [ $COUNT -gt 5 ]; then
            curl -X DELETE -H "Authorization: token $TOKEN" \
            https://api.github.com/repos/$REPO/releases/$ID
          fi
        done